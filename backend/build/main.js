!function(e){var t={};function s(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,o){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(o,i,function(t){return e[t]}.bind(null,i));return o},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=7)}([function(e,t){e.exports=require("express")},function(e,t){e.exports=require("sequelize")},function(e,t,s){const o=s(5);s(3).config({path:".env.production"});const{PRIVATE_KEY:i}=process.env;e.exports=function(e){return function(t,s,a){const l=t.cookies.authorization;if(!l)return s.status(401).send("Access denied. No token provided.");try{const n=o.verify(l,i);if(e){for(let s of e)if(n[s])return t.user=n,a();return s.status(401).send("Unauthorized to perform this action.")}return t.user=n,a()}catch(e){return s.status(400).clearCookie("authorization").send("Invalid token.")}}}},function(e,t){e.exports=require("dotenv")},function(e,t,s){"use strict";s(3).config({path:".env.production"});const{DB_HOST:o,DB_DATABASE:i,DB_USER:a,DB_PASSWORD:l}=process.env;console.log(o,i,a,l);const n=s(6),r=s(1),u=new r(i,a,l,{host:o,pool:{max:10,min:0,acquire:3e4,idle:1e4},dialect:"postgres",logging:!1,dialectOptions:{options:{useUTC:!1,dateFirst:1}},define:{timestamps:!1}}),d=u.define("organizations",{name:{type:r.STRING,allowNull:!1},shortName:{type:r.STRING,allowNull:!0},address:{type:r.STRING,allowNull:!0},city:{type:r.STRING,allowNull:!0},state:{type:r.STRING,allowNull:!0},zip:{type:r.INTEGER,min:1e4,max:99999,allowNull:!0},phone:{type:r.INTEGER,allowNull:!0},primaryColor:{type:r.STRING(6),allowNull:!0},secondaryColor:{type:r.STRING(6),allowNull:!0},logo:{type:r.BLOB,allowNull:!0}}),c=u.define("credentials",{email:{type:r.STRING,unique:!0,validate:{isEmail:!0},allowNull:!1},username:{type:r.STRING,unique:!0,allowNull:!1},password:{type:r.STRING,unique:!1,allowNull:!1},isAdmin:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1},isEmployee:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1},isAthlete:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1},isCoach:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1}},{hooks:{beforeValidate:async(e,t)=>{e.username=e.username||e.email.split("@")[0],e.password=await n.hash(e.password,10)}}});d.hasMany(c,{foreignKey:{allowNull:!1}}),c.belongsTo(d);const p=u.define("users",{schoolId:{type:r.STRING,allowNull:!0},firstName:{type:r.STRING,allowNull:!0},lastName:{type:r.STRING,allowNull:!0},address:{type:r.STRING,allowNull:!0},city:{type:r.STRING,allowNull:!0},state:{type:r.STRING,allowNull:!0},zip:{type:r.INTEGER,min:1e4,max:99999,allowNull:!0},phone:{type:r.INTEGER,allowNull:!0},lockerNumber:{type:r.INTEGER,allowNull:!0},lockerCode:{type:r.INTEGER,allowNull:!0},gender:{type:r.STRING(1),allowNull:!0},height:{type:r.INTEGER,comment:"in inches",allowNull:!0},weight:{type:r.INTEGER,comment:"in pounds",allowNull:!0}},{timestamps:!0});c.hasOne(p,{foreignKey:{allowNull:!1,unique:!0},onDelete:"CASCADE"}),p.belongsTo(c,{foreignKey:{allowNull:!1,unique:!0},onDelete:"CASCADE"}),d.hasMany(p,{foreignKey:{allowNull:!1}}),p.belongsTo(d,{foreignKey:{allowNull:!1}});const y=u.define("statuses",{name:{type:r.STRING,allowNull:!1},academicYear:{type:r.INTEGER,allowNull:!0}});y.hasMany(p),p.belongsTo(y);const m=u.define("sports",{name:{type:r.STRING,allowNull:!1},gender:{type:r.STRING(1),allowNull:!1}});d.hasMany(m,{foreignKey:{allowNull:!1}}),m.belongsTo(d,{foreignKey:{allowNull:!1}});const h=u.define("sport_sizes",{name:{type:r.STRING,allowNull:!1},sizes:{type:r.JSON,allowNull:!1,defaultValue:[]}},{timestamps:!1});m.hasMany(h,{foreignKey:{allowNull:!1}}),h.belongsTo(m,{foreignKey:{allowNull:!1}});const w=u.define("player_sports",{});p.belongsToMany(m,{through:"player_sports"}),m.belongsToMany(p,{through:"player_sports"});const g=u.define("inventories",{name:{type:r.STRING,allowNull:!1},description:{type:r.STRING,allowNull:!0},surplus:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1},taxable:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1},expendable:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1}},{timestamps:!0});h.hasMany(g),g.belongsTo(h),d.hasMany(g,{foreignKey:{allowNull:!1}}),g.belongsTo(d,{foreignKey:{allowNull:!1}});const f=u.define("inventory_sizes",{size:{type:r.STRING,allowNull:!1},barcode:{type:r.STRING,allowNull:!0},price:{type:r.DECIMAL,allowNull:!0},quantity:{type:r.INTEGER,allowNull:!1,defaultValue:0}},{timestamps:!0});g.hasMany(f),f.belongsTo(g);const N=u.define("equipment",{count:{type:r.INTEGER,allowNull:!1}},{timestamps:!0});p.hasMany(N,{foreignKey:{allowNull:!1}}),N.belongsTo(p,{foreignKey:{allowNull:!1}}),f.hasMany(N,{foreignKey:{allowNull:!1}}),N.belongsTo(f,{foreignKey:{allowNull:!1}}),d.hasMany(N,{foreignKey:{allowNull:!1}}),N.belongsTo(d,{foreignKey:{allowNull:!1}});const I=u.define("transactions",{amount:{type:r.INTEGER,allowNull:!1},returned:{type:r.BOOLEAN,allowNull:!1,defaultValue:!1}},{timestamps:!0});N.hasMany(I,{foreignKey:{allowNull:!1}}),I.belongsTo(N,{foreignKey:{allowNull:!1}}),p.hasMany(I,{as:"IssuedBy",foreignKey:{name:"issuedBy",allowNull:!1}}),I.belongsTo(p,{as:"IssuedBy",foreignKey:{name:"issuedBy",allowNull:!1}}),p.hasMany(I,{as:"IssuedTo",foreignKey:{name:"issuedTo",allowNull:!1}}),I.belongsTo(p,{as:"IssuedTo",foreignKey:{name:"issuedTo",allowNull:!1}}),d.hasMany(I,{foreignKey:{allowNull:!1}}),I.belongsTo(d,{foreignKey:{allowNull:!1}});const A=u.define("player_sizes",{size:{type:r.STRING,allowNull:!1}},{timestamps:!1});p.hasMany(A,{foreignKey:{allowNull:!1}}),A.belongsTo(p,{foreignKey:{allowNull:!1}}),h.hasMany(A,{foreignKey:{allowNull:!1}}),A.belongsTo(h,{foreignKey:{allowNull:!1}}),e.exports={User:p,Inventory:g,InventorySize:f,Equipment:N,Transaction:I,PlayerSize:A,PlayerSport:w,Sport:m,SportSize:h,Status:y,Credential:c,Organization:d,db:u}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("bcrypt")},function(e,t,s){const o=s(0),i=s(8),a=s(9),l=s(10),n=s(11),r=s(12),u=s(13),d=s(14),c=s(15),p=s(16);s(3).config({path:".env.production"});const{PORT:y,API_VER:m}=process.env,h=o();var w=["http://localhost:3000","https://stoplight.io"],g={origin:function(e,t){-1===w.indexOf(e)&&e?t(new Error("Not allowed by CORS")):t(null,!0)},methods:"GET,PUT,POST,DELETE",allowedHeaders:["x-access-token","authorization","Content-Type","Accept","Origin","X-Request-With"],credentials:!0};h.use(l(g)),h.use(o.json({limit:"50mb"})),h.use(o.urlencoded({extended:!0,limit:"10mb"})),h.use(i("dev")),h.use(a()),h.use(n()),h.use((e,t,s)=>{e.query=p.parse(e.url,!0).query,s()}),h.get("/",(e,t)=>{t.json({message:"Welcome to the AIMS API"})});const f=`/api/v${m}/`;h.use(f+"credentials",d),h.use(f+"users",r),h.use(f+"sports",u),h.use(f+"inventory",c),h.use("*",(e,t,s)=>{t.setHeader("Content-Type","application/json"),s()}),h.use((e,t)=>{t.status(404).json({message:"Route Not Found"})}),h.use((e,t,s,o)=>{s.status(500).json({message:e.message,error:{}})}),h.set("port",y||5e3);h.listen(h.get("port"),()=>{console.info(`Server listening on localhost:${y}`)})},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("helmet")},function(e,t,s){"use strict";const o=s(0),i=s(1),a=s(2),{User:l,PlayerSport:n,Sport:r,PlayerSize:u,Credential:d,SportSize:c}=s(4),p=o.Router();p.post("/",a(["isAdmin"]),async(e,t,s)=>{const o=e.body;try{let s=await d.create({email:o.email,username:o.username,password:o.password||"password123",organizationId:e.user.organizationId}),i=await l.create({schoolId:o.schoolId,firstName:o.firstname,lastName:o.lastName,address:o.address,city:o.city,state:o.state,zip:o.zip,phone:o.phone,gender:o.gender,height:o.height,weight:o.weight,lockerNumber:o.lockerNumber,lockerCode:o.lockerCode,credentialId:s.id,organizationId:e.user.organizationId});t.json(i)}catch(e){s(e)}}),p.get("/",a(["isAdmin","isEmployee","isCoach"]),async(e,t,s)=>{try{let s=[];const o=e.query.page*e.query.limit||0,a=e.query.limit||200;let p=e.user.isCoach&&!e.user.isAdmin&&!e.user.isEmployee;p&&(s=await n.findAll({offset:o,limit:a,where:{userId:e.user.id},attributes:["sportId"]}).map(e=>e.sportId));let y=await l.findAll({where:i.and({organizationId:e.user.organizationId},e.query.id?{id:e.query.id}:null,e.query.gender?{gender:e.query.gender}:null),include:[{model:r,attributes:["id","name","gender"],through:{attributes:[]},where:i.and(e.query["sports[]"]?i.or({id:e.query["sports[]"]}):null,p?i.or({id:s}):null)},{model:u,attributes:["id","sportSizeId","size"],include:[{model:c,attributes:["sportId","name","sizes"]}]},{model:d,attributes:e.user.isAdmin?{exclude:["organizationId","password"]}:["email","username"]}]});t.json(e.query.id&&1===y.length?y[0]:y)}catch(e){s(e)}}),p.get("/current",a(),async(e,t,s)=>{try{let s=await l.findOne({where:{credentialId:e.user.id},include:[{model:r,attributes:["id","name","gender"],through:{attributes:[]}},{model:u},{model:d,attributes:e.user.isAdmin?{exclude:["organizationId","password"]}:["email","username"]}]});t.json(s)}catch(e){s(e)}}),p.put("/current",a(),async(e,t,s)=>{let o=e.body;try{let s=await l.findOne({where:{credentialId:e.user.id}});e.user.isAdmin&&(s.schoolId=o.schoolId),(e.user.isAdmin||e.user.isEmployee)&&(s.lockerNumber=o.lockerNumber,s.lockerCode=o.lockerCode),s.firstName=o.firstname,s.lastName=o.lastName,s.address=o.address,s.city=o.city,s.state=o.state,s.zip=o.zip,s.phone=o.phone,s.gender=o.gender,s.height=o.height,s.weight=o.weight,await s.save(),t.json(s)}catch(e){s(e)}}),p.put("/",a(["isAdmin","isEmployee"]),async(e,t,s)=>{if(e.query.id){let o=e.body;try{let s=await l.findOne({where:{id:e.query.id}});e.user.isAdmin&&(s.schoolId=o.schoolId||s.schoolId),s.lockerNumber=o.lockerNumber||s.lockerNumber,s.lockerCode=o.lockerCode||s.lockerCode,s.firstName=o.firstname||s.firstName,s.lastName=o.lastName||s.lastName,s.address=o.address||s.address,s.city=o.city||s.city,s.state=o.state||s.state,s.zip=o.zip||s.zip,s.phone=o.phone||s.phone,s.gender=o.gender||s.gender,s.height=o.height||s.height,s.weight=o.weight||s.weight,await s.save(),t.json(s)}catch(e){s(e)}}else t.status(400).send("No user ID provided.")}),e.exports=p},function(e,t,s){"use strict";const o=s(0),{Sport:i,PlayerSport:a,User:l}=s(4),n=s(2),r=o.Router();r.post("/",n(["isAdmin"]),async(e,t,s)=>{const o=e.body;try{let s=await i.create({...o,organizationId:e.user.organizationId});t.json(s)}catch(e){s(e)}}),r.get("/",n(),async(e,t,s)=>{try{let s=await i.findAll({where:{organizationId:e.user.organizationId},attributes:{exclude:["organizationId"]}});t.json(s)}catch(e){s(e)}}),r.get("/:id",n(),async(e,t,s)=>{try{let s=await i.findOne({where:{id:e.params.id,organizationId:e.user.organizationId},attributes:{exclude:["organizationId"]}});t.json(s)}catch(e){s(e)}}),r.put("/:id",n(["isAdmin"]),async(e,t,s)=>{const o=e.body;try{await i.update({name:o.name,gender:o.gender,sizes:o.sizes},{where:{id:e.params.id,organizationId:e.user.organizationId}});let s=await i.findOne({where:{id:e.params.id},attributes:{exclude:["organizationId"]}});t.json(s)}catch(e){s(e)}}),r.delete("/:id",n(["isAdmin"]),async(e,t,s)=>{try{await i.destroy({where:{id:e.params.id,organizationId:e.user.organizationId}}),t.send("Sport "+e.params.id+" deleted.")}catch(e){s(e)}}),r.put("/user/:id",n(["isAdmin","isEmployee","isCoach"]),async(e,t,s)=>{let o=e.body.sports;try{let s=await a.findAll({where:{userId:e.params.id}}).map(e=>e.sportId),n=o.filter(e=>!s.includes(e)),r=s.filter(e=>!o.includes(e));for(let t of n)await a.create({userId:e.params.id,sportId:t});for(let t of r)await a.destroy({where:{userId:e.params.id,sportId:t}});let u=await l.findOne({where:{id:e.params.id},include:[{model:i,through:{attributes:[]}}]});t.json(u.sports)}catch(e){s(e)}}),e.exports=r},function(e,t,s){"use strict";const o=s(0),{Credential:i,Organization:a,User:l}=s(4),n=s(2),r=s(5),u=s(6),d=s(1),c=o.Router();s(3).config({path:".env.production"});const{PRIVATE_KEY:p}=process.env;c.get("/current",n(),async(e,t,s)=>{try{let s=await i.findOne({where:{id:e.user.id},attributes:["email","username","isAdmin","isEmployee","isAthlete","isCoach"],include:{model:a}});t.json(s)}catch(e){s(e)}}),c.post("/signup",async(e,t,s)=>{const o=e.body;try{let e=await i.create({email:o.email,username:o.username,password:o.password,organizationId:1});await l.create({credentialId:e.id,organizationId:e.organizationId});let s=await a.findOne({where:{id:1}});const n=await r.sign({id:e.id,organizationId:e.organizationId,isAdmin:e.isAdmin,isEmployee:e.isEmployee,isAthlete:e.isAthlete,isCoach:e.isCoach},p,{expiresIn:"30d"});t.status(201).cookie("authorization",n,{expires:o.remember?new Date(Date.now()+2592e6):0,httpOnly:!0}).json({email:e.email,username:e.username,isAdmin:e.isAdmin,isEmployee:e.isEmployee,isCoach:e.isCoach,isAthlete:e.isAthlete,organization:s})}catch(e){s(e)}}),c.post("/login",async(e,t,s)=>{const o=e.body;try{let e=await i.findOne({where:d.or({email:o.email},{username:o.username?o.username:o.email.split("@")[0]}),include:{model:a}});e?await u.compare(o.password,e.password,(s,i)=>{if(i){let s=r.sign({id:e.id,organizationId:e.organizationId,isAdmin:e.isAdmin,isEmployee:e.isEmployee,isAthlete:e.isAthlete,isCoach:e.isCoach},p,{expiresIn:"30d"});t.cookie("authorization",s,{expires:o.remember?new Date(Date.now()+2592e6):0,httpOnly:!0}).json({email:e.email,username:e.username,isAdmin:e.isAdmin,isEmployee:e.isEmployee,isCoach:e.isCoach,isAthlete:e.isAthlete,organization:e.organization})}else t.status(401).send("Credentials not valid")}):t.status(401).send("Credentials not found")}catch(e){s(e)}}),c.get("/logout",n(),async(e,t,s)=>{t.status(200).clearCookie("authorization").send("User has been logged out.")}),c.put("/current",n,async(e,t,s)=>{let o=e.body;try{let s=await i.findOne({where:{id:e.user.id}});if(s.email=o.email||s.email,s.username=o.username||s.username,e.user.isAdmin){s.isEmployee=!0===o.isEmployee||!1===o.isEmployee?o.isEmployee:s.isEmployee,s.isCoach=!0===o.isCoach||!1===o.isCoach?o.isCoach:s.isCoach,s.isAthlete=!0===o.isAthlete||!1===o.isAthlete?o.isAthlete:s.isAthlete,await s.save();let e=r.sign({id:s.id,organizationId:s.organizationId,isAdmin:s.isAdmin,isEmployee:s.isEmployee,isAthlete:s.isAthlete,isCoach:s.isCoach},p,{expiresIn:"30d"});t.cookie("authorization",e,{expires:0,httpOnly:!0})}t.send("Credential update successful")}catch(e){s(e)}}),c.put("/",n(["isAdmin"]),async(e,t,s)=>{if(e.query.id){let o=e.body;try{let s=await i.findOne({where:{id:e.query.id}});s.email=o.email||s.email,s.username=o.username||s.username,e.user.id!==s.id&&(s.isAdmin=!0===o.isAdmin||!1===o.isAdmin?o.isAdmin:s.isAdmin),s.isEmployee=!0===o.isEmployee||!1===o.isEmployee?o.isEmployee:s.isEmployee,s.isCoach=!0===o.isCoach||!1===o.isCoach?o.isCoach:s.isCoach,s.isAthlete=!0===o.isAthlete||!1===o.isAthlete?o.isAthlete:s.isAthlete,await s.save(),t.send("Credential update successful")}catch(e){s(e)}}else t.status(400).send("No user ID provided.")}),c.put("/change_password",n,async(e,t,s)=>{const o=e.body;try{let s=await i.findOne({where:{id:e.user.id}});s?await u.compare(o.password,s.password,async(e,i)=>{i?o.password!==o.newPassword?(console.log("Old: ",s.password),s.password=o.newPassword,console.log("Before: ",s.password),await s.save(),console.log("After: ",s.password),t.send("Password successfully changed.")):t.status(400).send("Password cannot match previous password."):t.status(401).send("Credentials not valid")}):t.status(401).send("Credentials not found")}catch(e){s(e)}}),e.exports=c},function(e,t,s){"use strict";const o=s(0),i=s(1),{Inventory:a}=s(4),l=s(2),n=o.Router();n.get("/",l(["isAdmin","isEmployee","isCoach"]),async(e,t,s)=>{try{let s=await a.findAll({where:i.and({organizationId:e.user.organizationId},e.query.id?{id:e.query.id}:null,e.query.surplus?{surplus:e.query.surplus}:null)});t.json(s)}catch(e){s(e)}}),e.exports=n},function(e,t){e.exports=require("url")}]);